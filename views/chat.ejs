<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat with <%= otherUser.name %></title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

  <header class="bg-gray-800 p-4 text-center text-xl font-semibold">
    Chat with <%= otherUser.name %>
  </header>

  <main class="flex-grow p-4 overflow-auto" id="chat-container" style="max-height: 70vh;">
    <% if (messages.length === 0) { %>
      <p class="text-center text-gray-400">No messages yet. Start the conversation!</p>
    <% } else { %>
      <% messages.forEach(message => { %>
        <div class="mb-3 max-w-xs p-3 rounded-lg <%= message.sender.toString() === user._id.toString() ? 'bg-indigo-600 self-end' : 'bg-gray-700 self-start' %>">
          <p><%= message.content %></p>
          <small class="text-gray-300 text-xs block mt-1">
            <%= new Date(message.timestamp).toLocaleString() %>
          </small>
        </div>
      <% }); %>
    <% } %>
  </main>

  <form action="/chat/<%= otherUser._id %>" method="POST" class="bg-gray-800 p-4 flex gap-2">
    <input name="content" type="text" placeholder="Type your message..." required
      class="flex-grow rounded px-4 py-2 text-black" autocomplete="off" />
    <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded text-white font-semibold">
      Send
    </button>
  </form>

  <script>
    const socket = io();

    const userId = '<%= user._id %>';
    const otherUserId = '<%= otherUser._id %>';

    socket.emit('join', userId);

    socket.on('receiveMessage', (msg) => {
      if (msg.from === otherUserId) {
        const chatContainer = document.getElementById('chat-container');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'mb-3 max-w-xs p-3 rounded-lg bg-gray-700 self-start';
        msgDiv.innerHTML = `<p>${msg.content}</p><small class="text-gray-300 text-xs block mt-1">${new Date(msg.timestamp).toLocaleString()}</small>`;
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    });

    // Optional: you can also emit sendMessage from client here if you implement realtime sending
  </script>

</body>
</html>